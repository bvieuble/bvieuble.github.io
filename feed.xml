<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://bvieuble.me/feed.xml" rel="self" type="application/atom+xml"/><link href="https://bvieuble.me/" rel="alternate" type="text/html" hreflang="en"/><updated>2025-07-08T01:43:49+00:00</updated><id>https://bvieuble.me/feed.xml</id><title type="html">blank</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. </subtitle><entry><title type="html">LaTeX tuto - Heatmaps grid with Lua</title><link href="https://bvieuble.me/blog/2025/tuto-heatmaps/" rel="alternate" type="text/html" title="LaTeX tuto - Heatmaps grid with Lua"/><published>2025-05-25T00:00:00+00:00</published><updated>2025-05-25T00:00:00+00:00</updated><id>https://bvieuble.me/blog/2025/tuto-heatmaps</id><content type="html" xml:base="https://bvieuble.me/blog/2025/tuto-heatmaps/"><![CDATA[<style>body{text-align:justify}</style> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/texfantasy/tuto_heatmaps_lua/tuto_heatmaps-480.webp 480w,/assets/img/texfantasy/tuto_heatmaps_lua/tuto_heatmaps-800.webp 800w,/assets/img/texfantasy/tuto_heatmaps_lua/tuto_heatmaps-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/texfantasy/tuto_heatmaps_lua/tuto_heatmaps.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <h2 id="tutorial-use-lua-to-automate-a-grid-of-heatmaps">Tutorial: use Lua to automate a grid of heatmaps</h2> <p>Consider the above \(3\times 3\) grid of heatmaps, where each heatmap represents the number of iterations according to \(\kappa(A)\) and \(\kappa(M)\) for a given variant of a numerical algorithm (e.g., L-DSD, F-DBD, or R-SBS). A relatively naive way to draw this plot would be to write a dedicated PGFPlots script for each of the nine heatmaps. As you can imagine, this approach has some big limitations. More specifically:</p> <ul> <li>If you need to change the style of the heatmaps, you need to propagate the change nine times.</li> <li>The source code will be larger and larger the bigger the number of heatmaps is.</li> <li>The layout of the grid, the size of the grid, or the sources of the data cannot be changed simply.</li> </ul> <p>Ultimately, we wish to write the PGFPlots script defining the style of the heatmap once and apply it nine times. Doing so, we need to take into account that from one heatmap to another there can be slight variations of style; for instance, the labels of the x- and/or y-axis may or may not be diplayed depending on the position of the heatmap in the grid. In addition, we want a convenient way to set different options for generating the grid. Specifically, we want to be able to change the grid layout (not necessarily \(3\times 3\)), the heatmaps’ size, or the sources of the data through user input parameters.</p> <p><strong>Source code for the tuto:</strong> the full compilable sources of the tuto can be <a href="https://github.com/bvieuble/TeXFantasy/tree/main/heatmaps/fig1">downloaded from github</a>. One can compile it at the root of the directory with</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lualatex <span class="nt">--shell-escape</span> figure.tex
</code></pre></div></div> <p>The option <code class="language-plaintext highlighter-rouge">--shell-escape</code> is optional and is only used to generate a .png alongside the .pdf.</p> <p><strong>Prerequisites for the tuto:</strong></p> <ul> <li>Basic notions of Lua. The Lua tutorial of <a href="https://www.tutorialspoint.com/lua/index.htm">tutorialspoint</a> is a good start.</li> <li>Good notions of PGFPlots, TikZ, and LaTeX. Specifically: drawing PGFPlots axis and knowing some of the basic axis options; have a basic understanding of the LaTeX macro system. One can check the <a href="https://mirror-hk.koddos.net/CTAN/graphics/pgf/contrib/pgfplots/doc/pgfplots.pdf">PGFPlots manual</a> if they encounter an axis option or a <code class="language-plaintext highlighter-rouge">pgfplots</code> command they don’t know.</li> <li>Basic notions of Lua code injections in .tex document. The <a href="https://www.alanshawn.com/tech/2020/06/20/luatex-intro.html">Alan Xiang’s Blog</a> provides a compact and good introduction.</li> </ul> <p><strong>Origin of the figure:</strong> the figure appears in the scientific article <a href="https://hal.science/hal-05071696/">Mixed precision strategies for preconditioned GMRES: a comprehensive analysis</a>.</p> <h3 id="lua-automation">Lua automation</h3> <p>Achieving the above goals requires a little more than <em>“simple LaTeX”</em> since we need some form of automation. Notably:</p> <ul> <li>Given a grid layout and the size of the heatmaps, we need to compute the position of each heatmap in the figure, accounting for the spacing between two heatmaps.</li> <li>We need to compute the position and size of the colorbar.</li> <li>We need to decide which heatmap will display tick labels on the x- and y-axes. In our figure, we display only x-axis labels for the heatmaps at the very bottom, and we display only the y-axis labels for the heatmaps at the very left of the grid. This allows us to save space and render a figure which is more compact and more suited for scientific journals.</li> </ul> <h5 style="text-align: center;"> <em> This requires some scripting! </em> </h5> <p><br/> While LaTeX already offers scripting capabilities through, for instance, the LaTeX3 commands and interfaces, or other utility commands found in various libraries such as the <code class="language-plaintext highlighter-rouge">\foreach</code> or <code class="language-plaintext highlighter-rouge">\pgfmathparse</code> of the package <code class="language-plaintext highlighter-rouge">pgfplots</code>, the syntax is arguably less intuitive and does not match the level of tools, efficiency, and simplicity that Lua can offer.</p> <h3 id="lua-based-config-file">Lua-based config file</h3> <p>We first tackle the problem of generating a grid of heatmaps given certain user input parameters. For this plot, we want the user to be able to set the following: the source of the data for each heatmap, the size of the heatmaps, and the number of heatmaps in one row of the grid.</p> <p>Naturally, it follows the question: how does the user provide values for these parameters? As for many things in LaTeX, there is no unanimous <em>“good answer”</em> on how to proceed, and different approaches are valid depending on the use cases and people’s preferences. I, your tutorial master and writer of this post, have a personal preference for defining those parameters in a separate Lua config file, which is simply a Lua module that will be loaded during the compilation. This has the advantage of clearly isolating the user inputs in one dedicated place, and to not have to be stored with the rest of the LaTeX source. In this tuto, we call this file <code class="language-plaintext highlighter-rouge">config.lua</code>, and you can find its content below:</p> <figure class="highlight"><pre><code class="language-lua" data-lang="lua"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="c1">-- config.lua</span>

<span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">config</span><span class="p">.</span><span class="n">gridcols</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">config</span><span class="p">.</span><span class="n">relativesize</span> <span class="o">=</span> <span class="p">.</span><span class="mi">31</span>
<span class="n">config</span><span class="p">.</span><span class="n">dircsv</span> <span class="o">=</span> <span class="s2">"./data"</span>
<span class="n">config</span><span class="p">.</span><span class="n">plots</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span><span class="s2">"left_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{l-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"right_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{r-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"flexible_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{f-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"left_dbd"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{l-dbd}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"right_dbd"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{r-dbd}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"flexible_dbd"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{f-dbd}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"left_dsd"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{l-dsd}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"right_dsd"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{r-dsd}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"flexible_dsd"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{f-dsd}"</span><span class="p">},</span>
<span class="p">}</span>

<span class="k">return</span> <span class="n">config</span>
</pre></td></tr></tbody></table></code></pre></figure> <p>In <code class="language-plaintext highlighter-rouge">config.lua</code>, the structure</p> <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="c1">-- [...]</span>
<span class="k">return</span> <span class="n">config</span>
</code></pre></div></div> <p>defines a Lua module; this is simply a table of key-value referenced as <code class="language-plaintext highlighter-rouge">config</code>. Inside the table <code class="language-plaintext highlighter-rouge">config</code>, we define different keys carrying our user input parameters:</p> <ul> <li><code class="language-plaintext highlighter-rouge">gridcols</code> is the number of heatmaps on each row.</li> <li><code class="language-plaintext highlighter-rouge">relativesize</code> defines the common size of all individual heatmaps. The true size of each heatmap in the document is <code class="language-plaintext highlighter-rouge">relativesize</code> \(\times\) <code class="language-plaintext highlighter-rouge">\linewidth</code>.</li> <li><code class="language-plaintext highlighter-rouge">dircsv</code> sets the path to the directory containing the heatmaps’ plot data in the form of .csv files.</li> <li><code class="language-plaintext highlighter-rouge">plots</code> is the list of the heatmaps to be plotted. They are defined with a pair of strings. Each pair of strings is composed, first, of the name of the corresponding .csv file containing the plot data and, second, the name/title of each heatmap to be displayed in the top right corner of the plot (e.g., L-DSD, F-DBD, or R-SBS).</li> </ul> <p>Our data directory <code class="language-plaintext highlighter-rouge">dircsv</code> looks as follows:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dircsv
├── bounds
│  ├── left_sbs.csv
│  ├── right_sbs.csv
│  └── ...
└──iterations 
    ├── left_sbs.csv
    ├── right_sbs.csv
    └── ...
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">dircsv/bounds/</code> subdirectory contains the .csv specifying which tiles of a given heatmap have a white dot. The <code class="language-plaintext highlighter-rouge">dircsv/iterations/</code> subdirectory contains the .csv that defines the number of iterations achieved on each tile.</p> <h3 id="compute-the-grid-layout-with-lua">Compute the grid layout with Lua</h3> <p>It is generally good practice to keep the Lua scripting out of the .tex file as much as possible. For this tutorial, we create a simple Lua module in a separate file <code class="language-plaintext highlighter-rouge">utils.lua</code> containing the function <code class="language-plaintext highlighter-rouge">get_grid(...)</code>. Based on the inputs provided by the user, this function will provide three main information to the main .tex file:</p> <ul> <li>The position of each heatmap in the grid.</li> <li>Tell if the x- and/or y-axis labels should be displayed for a given heatmap.</li> <li>The position and the size of the colorbar.</li> </ul> <p>The results are passed to the .tex file through the <code class="language-plaintext highlighter-rouge">grid</code> object, which is a table of key-value. The full details of the <code class="language-plaintext highlighter-rouge">utils.lua</code> module file is displayed below.</p> <figure class="highlight"><pre><code class="language-lua" data-lang="lua"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="code"><pre><span class="c1">-- utils.lua</span>

<span class="kd">local</span> <span class="n">utils</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">function</span> <span class="nc">utils</span><span class="p">.</span><span class="nf">get_grid</span><span class="p">(</span><span class="n">nbelt</span><span class="p">,</span> <span class="n">nbcols</span><span class="p">,</span> <span class="n">relativesize</span><span class="p">)</span>

  <span class="c1">-- Variables declaration</span>
  <span class="kd">local</span> <span class="n">grid</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">coordx</span><span class="p">,</span> <span class="n">coordy</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">xtick</span><span class="p">,</span> <span class="n">xticklabel</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">ytick</span><span class="p">,</span> <span class="n">yticklabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">{}</span>
  <span class="kd">local</span> <span class="n">sepx</span>   <span class="o">=</span> <span class="n">relativesize</span> <span class="o">/</span> <span class="mi">5</span>
  <span class="kd">local</span> <span class="n">sepy</span>   <span class="o">=</span> <span class="n">relativesize</span> <span class="o">/</span> <span class="mi">5</span>
  <span class="kd">local</span> <span class="n">cbarx</span><span class="p">,</span> <span class="n">cbary</span><span class="p">,</span> <span class="n">cbarsizeh</span><span class="p">,</span> <span class="n">cbarsizew</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

  <span class="c1">-- For each heatmap, compute its position in the grid and decide to display </span>
  <span class="c1">-- or not the x- and/or y-axis labels.</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbelt</span><span class="p">,</span> <span class="mi">1</span>
  <span class="k">do</span>
    <span class="n">xtick</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="n">xticklabel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xlabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{}"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"{}"</span>
    <span class="n">ytick</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="n">yticklabel</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ylabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{}"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"{}"</span>
    <span class="kd">local</span> <span class="n">row</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">(((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">nbcols</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">relativesize</span> <span class="o">+</span> <span class="n">sepy</span><span class="p">))</span>
    <span class="kd">local</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="n">nbcols</span>
    <span class="k">if</span> <span class="n">nbcols</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span>
      <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="kd">local</span> <span class="n">col</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">((</span><span class="n">tmp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">relativesize</span> <span class="o">+</span> <span class="n">sepx</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span>
      <span class="n">col</span> <span class="o">=</span> <span class="nb">tostring</span><span class="p">((</span><span class="n">nbcols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">relativesize</span> <span class="o">+</span> <span class="n">sepx</span><span class="p">))</span>
    <span class="k">elseif</span> <span class="n">tmp</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span>
      <span class="n">yticklabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">ylabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{$\\kappa(M)$}"</span>
    <span class="k">end</span>

    <span class="c1">-- Choose the tick labels density. If the size of the heatmap is small we</span>
    <span class="c1">-- display less tick labels, if this is big we display more.</span>
    <span class="k">if</span> <span class="n">relativesize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">3</span> <span class="k">then</span>
      <span class="n">xtick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{1,9,17}"</span>
      <span class="n">ytick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{1,9,17}"</span>
    <span class="k">elseif</span> <span class="n">relativesize</span> <span class="o">&lt;</span> <span class="p">.</span><span class="mi">7</span> <span class="k">then</span>
      <span class="n">xtick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{1,5,9,13,17}"</span>
      <span class="n">ytick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{1,5,9,13,17}"</span>
    <span class="k">elseif</span> <span class="n">relativesize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">.</span> <span class="k">then</span>
      <span class="n">xtick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{1,3,5,7,9,11,13,15,17}"</span>
      <span class="n">ytick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{1,3,5,7,9,11,13,15,17}"</span>
    <span class="k">else</span>
      <span class="n">xtick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17}"</span>
      <span class="n">ytick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17}"</span>
    <span class="k">end</span>

    <span class="n">coordx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span> <span class="o">..</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">linewidth"</span>
    <span class="n">coordy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span> <span class="o">..</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">linewidth"</span>
  <span class="k">end</span>

  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbcols</span><span class="p">,</span> <span class="mi">1</span>
  <span class="k">do</span>
    <span class="n">xticklabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">xlabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"{$\\kappa(A)$}"</span>
  <span class="k">end</span>

  <span class="c1">-- Compute the location and the size of the colorbar. The colorbar is located </span>
  <span class="c1">-- at the top of the grid.</span>
  <span class="n">cbarx</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbcols</span> <span class="o">*</span> <span class="p">(</span><span class="n">relativesize</span> <span class="o">+</span> <span class="n">sepx</span><span class="p">)</span> <span class="o">-</span> <span class="n">sepx</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nbelt</span> <span class="o">%</span> <span class="n">nbcols</span><span class="p">)</span> <span class="o">~=</span> <span class="mi">0</span> <span class="k">then</span>
    <span class="n">cbary</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbelt</span> <span class="o">//</span> <span class="n">nbcols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">relativesize</span> <span class="o">+</span> <span class="n">sepy</span><span class="p">)</span> <span class="o">-</span> <span class="n">sepy</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">35</span> <span class="o">*</span> <span class="n">relativesize</span>
  <span class="k">else</span>
    <span class="n">cbary</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbelt</span> <span class="o">//</span> <span class="n">nbcols</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">relativesize</span> <span class="o">+</span> <span class="n">sepy</span><span class="p">)</span> <span class="o">-</span> <span class="n">sepy</span> <span class="o">+</span> <span class="mi">0</span><span class="p">.</span><span class="mi">35</span> <span class="o">*</span> <span class="n">relativesize</span>
  <span class="k">end</span>
  <span class="n">cbarsizew</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbcols</span> <span class="o">*</span> <span class="p">(</span><span class="n">relativesize</span> <span class="o">+</span> <span class="n">sepx</span><span class="p">)</span> <span class="o">-</span> <span class="n">sepx</span><span class="p">)</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">7</span>
  <span class="n">cbarsizeh</span> <span class="o">=</span> <span class="n">relativesize</span> <span class="o">*</span> <span class="mi">0</span><span class="p">.</span><span class="mi">065</span>

  <span class="c1">-- Put the variables in a table grid for convenience.</span>
  <span class="n">grid</span><span class="p">.</span><span class="n">coordx</span><span class="p">,</span> <span class="n">grid</span><span class="p">.</span><span class="n">coordy</span> <span class="o">=</span> <span class="n">coordx</span><span class="p">,</span> <span class="n">coordy</span>
  <span class="n">grid</span><span class="p">.</span><span class="n">xtick</span><span class="p">,</span> <span class="n">grid</span><span class="p">.</span><span class="n">xticklabel</span><span class="p">,</span> <span class="n">grid</span><span class="p">.</span><span class="n">xlabel</span>  <span class="o">=</span> <span class="n">xtick</span><span class="p">,</span> <span class="n">xticklabel</span><span class="p">,</span> <span class="n">xlabel</span>
  <span class="n">grid</span><span class="p">.</span><span class="n">ytick</span><span class="p">,</span> <span class="n">grid</span><span class="p">.</span><span class="n">yticklabel</span><span class="p">,</span> <span class="n">grid</span><span class="p">.</span><span class="n">ylabel</span>  <span class="o">=</span> <span class="n">ytick</span><span class="p">,</span> <span class="n">yticklabel</span><span class="p">,</span> <span class="n">ylabel</span>
  <span class="n">grid</span><span class="p">.</span><span class="n">cbarx</span><span class="p">,</span> <span class="n">grid</span><span class="p">.</span><span class="n">cbary</span> <span class="o">=</span> <span class="n">cbarx</span><span class="p">,</span> <span class="n">cbary</span>
  <span class="n">grid</span><span class="p">.</span><span class="n">cbarsizew</span><span class="p">,</span> <span class="n">grid</span><span class="p">.</span><span class="n">cbarsizeh</span> <span class="o">=</span> <span class="n">cbarsizew</span><span class="p">,</span> <span class="n">cbarsizeh</span>
  <span class="k">return</span> <span class="n">grid</span>
<span class="k">end</span>

<span class="k">return</span> <span class="n">utils</span>
</pre></td></tr></tbody></table></code></pre></figure> <h3 id="overview-of-the-main-lualatex-code">Overview of the main LuaLaTeX code</h3> <p>We present the main LuaLaTeX code below that will generate the grid of heatmaps. One can compile the figure with</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lualatex <span class="nt">--shell-escape</span> heatmaps.tex
</code></pre></div></div> <p>The option <code class="language-plaintext highlighter-rouge">--shell-escape</code> is not essential and is only used to generate a .png alongside the .pdf. The overall is embedded in a <code class="language-plaintext highlighter-rouge">standalone</code> LaTeX document class, which is generally the way to go to draw and generate figures outside of a main LaTeX document. Through the <code class="language-plaintext highlighter-rouge">\includestandalone{figure}</code> command, it is also straightforward to embed this figure into another LaTeX document (e.g., article, beamer, book, etc.).</p> <figure class="highlight"><pre><code class="language-latex" data-lang="latex"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
</pre></td><td class="code"><pre><span class="c">% figure.tex</span>

<span class="k">\documentclass</span><span class="na">[convert={outext=.png},border=10pt]</span><span class="p">{</span>standalone<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>fontspec<span class="p">}</span>
<span class="k">\setmainfont</span><span class="p">{</span>Roboto<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>pgfplots<span class="p">}</span>
<span class="k">\pgfplotsset</span><span class="p">{</span>compat=newest<span class="p">}</span>
<span class="k">\usepackage</span><span class="p">{</span>luacode<span class="p">}</span>

<span class="k">\definecolor</span><span class="p">{</span>fg<span class="p">}{</span>RGB<span class="p">}{</span>150,150,150<span class="p">}</span> <span class="c">% Foreground color</span>
<span class="k">\pgfplotsset</span><span class="p">{</span>filter discard warning=false<span class="p">}</span>

<span class="nt">\begin{document}</span>
<span class="c">%</span>
<span class="k">\pgfplotsset</span><span class="p">{</span>title style=<span class="p">{</span>xshift=1cm,yshift=-0.2cm<span class="p">}}</span><span class="c">%</span>
<span class="c">%</span>
<span class="k">\pgfmathdeclarefunction</span><span class="p">{</span>lg10<span class="p">}{</span>1<span class="p">}{</span> <span class="c">%</span>
    <span class="k">\pgfmathparse</span><span class="p">{</span>ln(#1)/ln(10)<span class="p">}</span><span class="c">%</span>
<span class="p">}</span><span class="c">%</span>
<span class="c">%</span>
<span class="c">% Load utils.lua and config.lua.</span>
<span class="nt">\begin{luacode*}</span>
  -- utils.lua contains lua functions to be called to be called in this file.
  myutils = require("utils")
  -- config.lua contains the user input parameters.
  myconfig = require("config")
<span class="nt">\end{luacode*}</span>
<span class="c">%</span>
<span class="c">% Define a LaTeX command that generates one heatmap. Inside the command, there</span>
<span class="c">% are various macros that define style options and data paths, such as,</span>
<span class="c">% "\varxtick", "\varsize" or "\vardatait". These macros should be initialized </span>
<span class="c">% before calling the \heatmaps command.</span>
<span class="k">\newcommand</span><span class="p">{</span><span class="k">\heatmap</span><span class="p">}</span>
<span class="p">{</span> <span class="c">%</span>
  <span class="nt">\begin{axis}</span>[
    <span class="c">% x-axis style</span>
    minor xtick=<span class="p">{</span>1.5,2.5,...,16.5<span class="p">}</span>,
    x label style=<span class="p">{</span>font=<span class="k">\normalsize</span><span class="p">}</span>,
    xtick=<span class="k">\varxtick</span>, <span class="c">% Recover x-ticks positions from macro</span>
    xticklabel=<span class="p">{</span>
     <span class="k">\if\varxticklabel</span> 1
       <span class="k">\pgfmathparse</span><span class="p">{</span><span class="k">\tick</span>-1<span class="p">}</span>
       <span class="p">$</span><span class="m">10</span><span class="p">^{</span><span class="nv">\pgfmathprintnumber</span><span class="p">{</span><span class="nv">\pgfmathresult</span><span class="p">}}$</span>
     <span class="k">\fi</span>
    <span class="p">}</span>,
    x tick label style=<span class="p">{</span>font=<span class="k">\small</span><span class="p">}</span>,
    xlabel=<span class="k">\varxlabel</span>, <span class="c">% Recover the x-axis label from macro</span>
    enlarge x limits=<span class="p">{</span>abs=0.<span class="p">}</span>,
    <span class="c">% y-axis style</span>
    minor ytick=<span class="p">{</span>1.5,2.5,...,16.5<span class="p">}</span>,
    y label style=<span class="p">{</span>at=<span class="p">{</span>(axis description cs:-0.15,0.5)<span class="p">}</span>,rotate=0,font=<span class="k">\normalsize</span><span class="p">}</span>,
    ytick=<span class="p">{</span><span class="k">\varytick</span><span class="p">}</span>, <span class="c">% Recover y-ticks positions from macro</span>
    yticklabel=<span class="p">{</span>
     <span class="k">\if\varyticklabel</span> 1
       <span class="k">\pgfmathparse</span><span class="p">{</span><span class="k">\tick</span>-1<span class="p">}</span>
       <span class="p">$</span><span class="m">10</span><span class="p">^{</span><span class="nv">\pgfmathprintnumber</span><span class="p">{</span><span class="nv">\pgfmathresult</span><span class="p">}}$</span>
     <span class="k">\fi</span>
    <span class="p">}</span>,
    y tick label style=<span class="p">{</span>font=<span class="k">\small</span>,rotate=90<span class="p">}</span>,
    ylabel=<span class="k">\varylabel</span>, <span class="c">% Recover the y-axis label from macro</span>
    enlarge y limits=<span class="p">{</span>abs=0.<span class="p">}</span>,
    <span class="c">% Other style</span>
    grid=minor,
    tick style=<span class="p">{</span>draw=none<span class="p">}</span>, <span class="c">% Hide the ticks</span>
    minor grid style=<span class="p">{</span>fg,very thin<span class="p">}</span>,
    axis on top,
    mesh/ordering=y varies, 
    unbounded coords=jump,
    height=<span class="k">\varsize\linewidth</span>, <span class="c">% Set the size (height and width) from macro</span>
    width=<span class="k">\varsize\linewidth</span>,
    colormap=<span class="p">{</span>whiteblue<span class="p">}{</span>color=<span class="p">{</span>black<span class="p">}</span> color=(white)<span class="p">}</span>,
    point meta min=0,
    point meta max=4,
    view=<span class="p">{</span>0<span class="p">}{</span>90<span class="p">}</span>,
    scale only axis=true, <span class="c">% Enforce the paramaters height and width to describe</span>
                          <span class="c">% the size of the axis without including the </span>
                          <span class="c">% decorations</span>
    title=<span class="k">\textsc</span><span class="p">{</span><span class="k">\vartitle</span><span class="p">}</span>, <span class="c">% Recover the name of the heatmap from macro</span>
    at=<span class="p">{</span>(<span class="k">\varcoordx</span>,<span class="k">\varcoordy</span>)<span class="p">}</span>, <span class="c">% Recover the position of the heatmap from</span>
                                  <span class="c">% macro</span>
  ]<span class="c">%</span>
  <span class="k">\addplot</span><span class="na">[matrix plot*,mesh/rows=17,point meta=explicit]</span>
      table[meta expr=lg10(<span class="k">\thisrow</span><span class="p">{</span>it<span class="p">}</span>),col sep=comma]
      <span class="p">{</span><span class="k">\vardatait</span><span class="p">}</span>; <span class="c">% Obtain the data path from macro</span>
  <span class="k">\addplot</span><span class="na">[white,only marks,mark=*,mark size=0.75pt]</span> 
      table[col sep=comma] <span class="p">{</span><span class="k">\vardatabounds</span><span class="p">}</span>; <span class="c">% Obtain the data path from macro</span>
  <span class="nt">\end{axis}</span>
<span class="p">}</span><span class="c">%</span>
<span class="c">%</span>
<span class="c">% Define a LaTeX command that generates the colorbar. Because all the heatmaps</span>
<span class="c">% of the grid share the same colorbar, we need to define the colorbar as a</span>
<span class="c">% standalone, outside of the heatmap plots. To do so we use the </span>
<span class="c">% `\pgfplotscolorbardrawstandalone[...].`</span>
<span class="k">\newcommand</span><span class="p">{</span><span class="k">\heatcolorbar</span><span class="p">}</span>
<span class="p">{</span> <span class="c">%</span>
  <span class="k">\pgfplotscolorbardrawstandalone</span>[
    colormap=<span class="p">{</span>whiteblue<span class="p">}{</span>color=<span class="p">{</span>black<span class="p">}</span> color=(white)<span class="p">}</span>,
    point meta min=0,
    point meta max=3.68,
    colorbar horizontal,
    colorbar style=<span class="p">{</span>
       ylabel=<span class="p">{</span><span class="k">\#</span>it<span class="p">}</span>,
       yticklabel pos=upper,
       ylabel style=<span class="p">{</span>rotate=-90, xshift=.22cm<span class="p">}</span>,
       xtick=<span class="p">{</span>0,1,1.7,2,2.70,3,3.68<span class="p">}</span>,
       xticklabels=<span class="p">{$</span><span class="m">1</span><span class="nb">e</span><span class="m">0</span><span class="p">$</span>, <span class="p">$</span><span class="m">1</span><span class="nb">e</span><span class="m">1</span><span class="p">$</span>, <span class="p">$</span><span class="m">5</span><span class="nb">e</span><span class="m">1</span><span class="p">$</span>, <span class="p">$</span><span class="m">1</span><span class="nb">e</span><span class="m">2</span><span class="p">$</span>, <span class="p">$</span><span class="m">5</span><span class="nb">e</span><span class="m">2</span><span class="p">$</span>, <span class="p">$</span><span class="m">1</span><span class="nb">e</span><span class="m">3</span><span class="p">$</span>, <span class="p">$</span><span class="m">5</span><span class="nb">e</span><span class="m">3</span><span class="p">$}</span>,
       x tick label style=<span class="p">{</span>font=<span class="k">\footnotesize</span><span class="p">}</span>,
       xticklabel pos=upper,
       at=<span class="p">{</span>(<span class="k">\varcbarx\linewidth</span>,<span class="k">\varcbary\linewidth</span>)<span class="p">}</span>, 
       width=<span class="k">\varcbarsizew\linewidth</span>,
       anchor=center, <span class="c">% The position of the colorbar defined with `at` is now</span>
       <span class="c">% based on the center of the figure rather than the left bottom corner</span>
    <span class="p">}</span>,
    colorbar/width=<span class="k">\varcbarsizeh\linewidth</span>,
    colormap access=map,
  ]<span class="c">%</span>
<span class="p">}</span><span class="c">%</span>
<span class="c">%</span>
<span class="nt">\begin{tikzpicture}</span>[fg]
  <span class="nt">\begin{luacode*}</span>

    -- Get the grid information based on the user input parameters in
    -- config.lua and computed from the function `get<span class="p">_</span>grid<span class="p">_</span>heatmaps(...)`
    -- loaded from utils.lua.
    grid = myutils.get<span class="p">_</span>grid(#myconfig.plots, myconfig.gridcols,
                            myconfig.relativesize)

    -- Loop over the heatmaps
    for i = 1, #myconfig.plots
    do
      
      -- Extract name of the heatmap and the source of the data from config.lua
      title   = myconfig.plots[i][2]
      pathcsv<span class="p">_</span>it = myconfig.dircsv .. "/iterations/" ..  myconfig.plots[i][1] 
        .. ".csv"
      pathcsv<span class="p">_</span>bounds = myconfig.dircsv .. "/bounds/" .. myconfig.plots[i][1] 
        .. ".csv"
      
      -- Set the LaTeX macros that will define the style of the current heatmap
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>vardatait<span class="p">{</span>"       .. pathcsv<span class="p">_</span>it             .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>vardatabounds<span class="p">{</span>"   .. pathcsv<span class="p">_</span>bounds         .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>vartitle<span class="p">{</span>"        .. title                  .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varcoordx<span class="p">{</span>"       .. grid.coordx[i]         .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varcoordy<span class="p">{</span>"       .. grid.coordy[i]         .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varsize<span class="p">{</span>"         .. myconfig.relativesize  .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varxtick<span class="p">{</span>"        .. grid.xtick[i]          .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varxticklabel<span class="p">{</span>"   .. grid.xticklabel[i]     .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varxlabel<span class="p">{</span>"       .. grid.xlabel[i]         .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varytick<span class="p">{</span>"        .. grid.ytick[i]          .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varyticklabel<span class="p">{</span>"   .. grid.yticklabel[i]     .. "<span class="p">}</span>")
      tex.print("<span class="k">\\</span>def<span class="k">\\</span>varylabel<span class="p">{</span>"       .. grid.ylabel[i]         .. "<span class="p">}</span>")

      -- Generate the current heatmap
      tex.print("<span class="k">\\</span>heatmap")
    end

    -- Set the LaTeX macros that will define the style of the colorbar
    tex.print("<span class="k">\\</span>def<span class="k">\\</span>varcbarx<span class="p">{</span>"      .. grid.cbarx     .. "<span class="p">}</span>")
    tex.print("<span class="k">\\</span>def<span class="k">\\</span>varcbary<span class="p">{</span>"      .. grid.cbary     .. "<span class="p">}</span>")
    tex.print("<span class="k">\\</span>def<span class="k">\\</span>varcbarsizew<span class="p">{</span>"  .. grid.cbarsizew .. "<span class="p">}</span>")
    tex.print("<span class="k">\\</span>def<span class="k">\\</span>varcbarsizeh<span class="p">{</span>"  .. grid.cbarsizeh .. "<span class="p">}</span>")

    -- Generate the colorbar
    tex.print("<span class="k">\\</span>heatcolorbar")

  <span class="nt">\end{luacode*}</span>
<span class="nt">\end{tikzpicture}</span><span class="c">%</span>
<span class="nt">\end{document}</span>
</pre></td></tr></tbody></table></code></pre></figure> <div style="text-align: center;"> <b> Let's describe the file and its logic piece by piece, from top to bottom. </b> </div> <p><br/> After the document class declaration, we load the different useful packages to compile the figure. The dependencies are relatively lightweight; we mostly need two main LaTeX packages (note that internally each of these two packages loads other packages):</p> <div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\usepackage</span><span class="p">{</span>pgfplots<span class="p">}</span> <span class="c">% LaTeX package to generate a wide diversity of </span>
                      <span class="c">% scientific plots.</span>
<span class="k">\usepackage</span><span class="p">{</span>luacode<span class="p">}</span>  <span class="c">% A set of environments and commands to ease the </span>
                      <span class="c">% Lua-LaTeX interfacing.</span>
</code></pre></div></div> <p>Once in the document’s body, we load our two Lua modules <code class="language-plaintext highlighter-rouge">config.lua</code> and <code class="language-plaintext highlighter-rouge">utils.lua</code> described in, respectively, <a href="#lua-based-config-file">Lua-based config file</a> and <a href="#compute-the-grid-layout-with-lua">Compute the grid layout with Lua</a>. We load the modules as we would do it in standard Lua by writing</p> <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">myutils</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"utils"</span><span class="p">)</span>
<span class="n">myconfig</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"config"</span><span class="p">)</span>
</code></pre></div></div> <p>in a <code class="language-plaintext highlighter-rouge">\begin{luacode*} [...] \end{luacode*}</code> LaTeX environment, which is the environment in which Lua scripts can be executed inside a .tex document. The different functions and variables defined in the modules are now conveniently accessible through the namespaces <code class="language-plaintext highlighter-rouge">myutils</code> and <code class="language-plaintext highlighter-rouge">myconfig</code>.</p> <p>We then define the <em>“pure LaTeX”</em> command</p> <div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\newcommand</span><span class="p">{</span><span class="k">\heatmap</span><span class="p">}{</span>
  <span class="c">% [...]</span>
<span class="p">}</span>
</code></pre></div></div> <p>which serves to plot the heatmaps of the grid. The advantage of embedding the style of the heatmaps into one LaTeX command is that we can write the style only once and apply it multiple times.</p> <p>However, as explained previously, the different heatmaps of the grid do not have exactly the same style; for example, titles, positions, or tick labels can change from one heatmap to another. A simple approach to address this issue is to pass this information as parameters of the command. For instance, by declaring the command as <code class="language-plaintext highlighter-rouge">\newcommand{\heatmap}[2]{...}</code>, the command <code class="language-plaintext highlighter-rouge">\heatmap</code> takes now two parameters. Unfortunately, a LaTeX command can only accept up to nine parameters, which cannot suit our use case here; see this <a href="https://tex.stackexchange.com/questions/2132/how-to-define-a-command-that-takes-more-than-9-arguments">StackExchange question</a>. There are different ways to overcome this problem. We chose to rely on a LaTeX macro approach for this tutorial. With this approach, the command <code class="language-plaintext highlighter-rouge">\heatmap</code> is defined without parameters, but internally uses a set of LaTeX macros used as variables: <code class="language-plaintext highlighter-rouge">\varxtick</code>, <code class="language-plaintext highlighter-rouge">\varxlabel</code>, <code class="language-plaintext highlighter-rouge">\varsize</code>, <code class="language-plaintext highlighter-rouge">\vardatait</code>, etc. For instance, the macro <code class="language-plaintext highlighter-rouge">\varsize</code> is used to set the size of the heatmap; the macro <code class="language-plaintext highlighter-rouge">\vardatait</code> sets the path to the .csv file containing the data to be plotted. These macros can be redefined between each call of the command <code class="language-plaintext highlighter-rouge">\heatmap</code>, which allows us to change the style from heatmap to heatmap.</p> <p>We define another command</p> <div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\newcommand</span><span class="p">{</span><span class="k">\heatcolorbar</span><span class="p">}{</span>
  <span class="c">% [...]</span>
<span class="p">}</span>
</code></pre></div></div> <p>which works similarly to <code class="language-plaintext highlighter-rouge">\heatmap</code>. This command plots the colorbar of the figure. In more standard use cases, the colorbar is defined inside the <code class="language-plaintext highlighter-rouge">axis</code> environment of the plot. However, in our case, as the colorbar is shared across all the heatmaps of the grid, we use <code class="language-plaintext highlighter-rouge">\pgfplotscolorbardrawstandalone</code> to draw it as a standalone, which gives us more flexibility.</p> <p>Finally, we enter the definition of the TikZpicture which is fully automated by Lua instructions:</p> <div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{tikzpicture}</span>[fg]
  <span class="nt">\begin{luacode*}</span>
    <span class="c">% [...]</span>
  <span class="nt">\end{luacode*}</span>
<span class="nt">\end{tikzpicture}</span>
</code></pre></div></div> <p>We first call</p> <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grid</span> <span class="o">=</span> <span class="n">myutils</span><span class="p">.</span><span class="n">get_grid</span><span class="p">(</span><span class="o">#</span><span class="n">myconfig</span><span class="p">.</span><span class="n">plots</span><span class="p">,</span> <span class="n">myconfig</span><span class="p">.</span><span class="n">gridcols</span><span class="p">,</span> <span class="n">myconfig</span><span class="p">.</span><span class="n">relativesize</span><span class="p">)</span>
</code></pre></div></div> <p>which <a href="#compute-the-grid-layout-with-lua">computes the grid layout</a> based on the <a href="#lua-based-config-file">user input parameters of the config file</a>. With the grid layout information computed and stored in a Lua table <code class="language-plaintext highlighter-rouge">grid</code>, we then loop over the heatmaps, set the variables defining the style of the current heatmap with</p> <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\vardatait{"</span>       <span class="o">..</span> <span class="n">pathcsv_it</span>             <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\vardatabounds{"</span>   <span class="o">..</span> <span class="n">pathcsv_bounds</span>         <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\vartitle{"</span>        <span class="o">..</span> <span class="n">title</span>                  <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varcoordx{"</span>       <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">coordx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>         <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varcoordy{"</span>       <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">coordy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>         <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varsize{"</span>         <span class="o">..</span> <span class="n">myconfig</span><span class="p">.</span><span class="n">relativesize</span>  <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varxtick{"</span>        <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">xtick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>          <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varxticklabel{"</span>   <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">xticklabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varxlabel{"</span>       <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">xlabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>         <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varytick{"</span>        <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">ytick</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>          <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varyticklabel{"</span>   <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">yticklabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>     <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varylabel{"</span>       <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">ylabel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>         <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
</code></pre></div></div> <p>and generate the current heatmap by calling</p> <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">heatmap"</span><span class="p">)</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">tex.print(...)</code> Lua function is one of the main way for Lua to provide materials to be read and interpreted by LaTeX. It basically pushes the string in parameter of <code class="language-plaintext highlighter-rouge">tex.print</code> in the TeX input buffer. Hence, with the previous set of Lua instructions, the LaTeX compiler will see</p> <div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">\def\vardatait</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\vardatabounds</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\vartitle</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varcoordx</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varcoordy</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varsize</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varxtick</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varxticklabel</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varxlabel</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varytick</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varyticklabel</span><span class="p">{</span>...<span class="p">}</span>
<span class="k">\def\varylabel</span><span class="p">{</span>...<span class="p">}</span>

<span class="k">\heatmap</span>
</code></pre></div></div> <p>At the very end, once all the heatmaps are generated, we generate the colorbar in a very similar fashion:</p> <div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varcbarx{"</span>      <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">cbarx</span>     <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varcbary{"</span>      <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">cbary</span>     <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varcbarsizew{"</span>  <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">cbarsizew</span> <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>
<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">def\\varcbarsizeh{"</span>  <span class="o">..</span> <span class="n">grid</span><span class="p">.</span><span class="n">cbarsizeh</span> <span class="o">..</span> <span class="s2">"}"</span><span class="p">)</span>

<span class="n">tex</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">heatcolorbar"</span><span class="p">)</span>
</code></pre></div></div> <h5 style="text-align: center;"> <em> With this approach we keep as much as possible the LaTeX instructions outside of Lua scripts, and vice versa. </em> </h5> <p><br/> The overlap between LaTeX and Lua is confined to the environment</p> <div class="language-latex highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">\begin{tikzpicture}</span>[fg]
  <span class="nt">\begin{luacode*}</span>
    <span class="c">% [...]</span>
  <span class="nt">\end{luacode*}</span>
<span class="nt">\end{tikzpicture}</span>
</code></pre></div></div> <p>where we orchestrate the interactions between the user input parameters, the Lua logic, and the style of the plots expressed in LaTeX.</p> <h3 id="examples-of-run">Examples of run</h3> <p>Generating different grids of heatmaps requires only changing the parameters of the <code class="language-plaintext highlighter-rouge">config.lua</code> file.</p> <h4 id="example-1">Example 1</h4> <figure class="highlight"><pre><code class="language-lua" data-lang="lua"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="c1">-- config.lua</span>

<span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">config</span><span class="p">.</span><span class="n">gridcols</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">config</span><span class="p">.</span><span class="n">relativesize</span> <span class="o">=</span> <span class="p">.</span><span class="mi">24</span>
<span class="n">config</span><span class="p">.</span><span class="n">dircsv</span> <span class="o">=</span> <span class="s2">"./data/csv/heatmaps"</span>
<span class="n">config</span><span class="p">.</span><span class="n">plots</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span><span class="s2">"left_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{l-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"right_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{r-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"flexible_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{f-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"left_dbd"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{l-dbd}"</span><span class="p">},</span>
<span class="p">}</span>

<span class="k">return</span> <span class="n">config</span>
</pre></td></tr></tbody></table></code></pre></figure> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/texfantasy/tuto_heatmaps_lua/example1-480.webp 480w,/assets/img/texfantasy/tuto_heatmaps_lua/example1-800.webp 800w,/assets/img/texfantasy/tuto_heatmaps_lua/example1-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/texfantasy/tuto_heatmaps_lua/example1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Example with four heatmaps in one row. </div> <h4 id="example-2">Example 2</h4> <figure class="highlight"><pre><code class="language-lua" data-lang="lua"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="c1">-- config.lua</span>

<span class="kd">local</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">config</span><span class="p">.</span><span class="n">gridcols</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">config</span><span class="p">.</span><span class="n">relativesize</span> <span class="o">=</span> <span class="p">.</span><span class="mi">3</span>
<span class="n">config</span><span class="p">.</span><span class="n">dircsv</span> <span class="o">=</span> <span class="s2">"./data/csv/heatmaps"</span>
<span class="n">config</span><span class="p">.</span><span class="n">plots</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span><span class="s2">"left_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{l-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"right_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{r-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"flexible_sbs"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{f-sbs}"</span><span class="p">},</span>
  <span class="p">{</span><span class="s2">"left_dbd"</span><span class="p">,</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">textsc{l-dbd}"</span><span class="p">},</span>
<span class="p">}</span>

<span class="k">return</span> <span class="n">config</span>
</pre></td></tr></tbody></table></code></pre></figure> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/texfantasy/tuto_heatmaps_lua/example2-480.webp 480w,/assets/img/texfantasy/tuto_heatmaps_lua/example2-800.webp 800w,/assets/img/texfantasy/tuto_heatmaps_lua/example2-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/texfantasy/tuto_heatmaps_lua/example2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="example image" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Example with a two by two grid. </div> <h3 id="other-lua-powered-figures">Other Lua-powered figures</h3> <p>The same system combining Lua config file and Lua scripts with a TikZ/PGFPlots project can be used to draw many different scientific figures. Find below a few other examples:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <a href="http://bvieuble.me/texfantasy/19_tex/"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/texfantasy/tex19-front-480.webp 480w,/assets/img/texfantasy/tex19-front-800.webp 800w,/assets/img/texfantasy/tex19-front-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/texfantasy/tex19-front.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </a> </div> <div class="col-sm mt-3 mt-md-0"> <a href="http://bvieuble.me/texfantasy/20_tex/"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/texfantasy/tex20-front-480.webp 480w,/assets/img/texfantasy/tex20-front-800.webp 800w,/assets/img/texfantasy/tex20-front-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/texfantasy/tex20-front.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </a> </div> </div> <div class="caption"> Other figures of the TeXFantasy collection using Lua. Click on the image to see the full plot. </div>]]></content><author><name></name></author><category term="texfantasy"/><category term="latex"/><category term="tutorial"/><summary type="html"><![CDATA[Learn to draw a grid of heatmaps using PGFPlots and Lua.]]></summary></entry><entry><title type="html">Academic visit in China (1/3)</title><link href="https://bvieuble.me/blog/2025/chinavisit1/" rel="alternate" type="text/html" title="Academic visit in China (1/3)"/><published>2025-02-10T00:01:00+00:00</published><updated>2025-02-10T00:01:00+00:00</updated><id>https://bvieuble.me/blog/2025/chinavisit1</id><content type="html" xml:base="https://bvieuble.me/blog/2025/chinavisit1/"><![CDATA[<style>body{text-align:justify}</style> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blog/passport-480.webp 480w,/assets/img/blog/passport-800.webp 800w,/assets/img/blog/passport-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/blog/passport.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h2 id="invited-by-peers-in-china-you-are-at-the-good-place">Invited by peers in China? You are at the good place!</h2> <p>You are a senior or young researcher and have been invited by a peer to give a talk at a Chinese institute or university, to give a class, to attend a conference or a workshop? You wish to accept but wonder if you need to apply for a visa? And if so, what documents you need for the application? How to organize your trip? What you should know before going? How will you sustain yourself when you’re there? Say no more, you are in the right place!</p> <p>First things first, if you are dealing with a renowned Chinese academic institute, you can sit back and relax, you are in good hands! They know their business, you are not the first foreigner they invite and you won’t be the last. Your Chinese peers will take it to heart to provide you with the best and smoothest experience. In all fairness, you’ll likely be provided with more accurate instructions and information than this simple guide. Yet, as I was once in your exact situation, I might still be able to provide you with some good tips.</p> <p>If you wish to keep up with me, we will cover three main topics which should help you get the best experience possible out of your academic visit in China. The first part of my guide, which you are now reading, covers your right of entry into mainland China. This includes your eligibility for visa exemption and, if not eligible, the procedure to apply for a visa for the purpose of an academic visit. If you are already up-to-date on visa matters, you can go check out the next parts of the guide listed in <a href="#continue-the-guide">Continue the Guide</a> and print your <a href="https://bvieuble.me/blog/2025/chinavisit4">TODO list</a>.</p> <h2 id="visa-or-not-visa">Visa or not visa?</h2> <p>Ultimately, if you read this post, you are likely NOT to hold a Chinese passport or a Chinese residence permit. Hence, you need to carefully check the rules that apply to you to enter mainland China. Regulations in the matter have highly fluctuated these last few years, most often in the direction of leveraging or simplifying the requirements. Hence, at the time you read this post, certain information I present might be incomplete or wrong. I therefore strongly recommend checking the regulations presented on the official websites of your government or the websites of the Chinese embassies, consulates, or visa application centers in your country.</p> <h3 id="visa-exemption">Visa exemption</h3> <p>As of today, if you hold a passport from certain countries in the European Union, East Asia, Oceania, and more, chances are that you are exempt from holding a visa for academic exchange for a duration of less than 30 days. This would give you more than enough time to attend most workshops, conferences, or seminars. The most reliable way to know if you are eligible for such an exemption is to check the travel information provided by your government or the Chinese embassies in your home country. You can also check the <a href="https://travelchina.guide/visa/free">Travel China</a> website which lists the visa-exempt countries, or find some official information on the <a href="https://www.mfa.gov.cn/wjbzwfwpt/kzx/tzgg/202411/t20241130_11535783.html">Chinese government</a> website.</p> <blockquote class="block-tip"> <h5 id="-valid-purposes-of-visit-for-visa-exemption">✅ Valid purposes of visit for visa exemption</h5> <p>The exemptions generally cover entries to mainland China for the purpose of business, tourism, family or friends visits, exchange, and transit. Short academic visits fall within the “exchange” classification.</p> </blockquote> <p>Be careful, being exempt from holding a visa does not mean you can arrive at the border unprepared. You need to be ready to provide the border agent with some proof of the purpose of your visit if asked. In the case of a short academic visit, it falls down to the following documents:</p> <ul> <li>A <strong>valid passport</strong> (I mean…).</li> <li>An <strong>invitation letter</strong> from your academic host in China. The letter should be addressed to you and should provide basic information, such as a short description of the activities you will engage in, the dates of your visit to the host institution, the host’s contact information, etc.</li> <li>Reservation of <strong>airplane tickets</strong>, especially the flight out of China proving that you are scheduled to leave the Chinese territory.</li> <li>Reservations of <strong>accommodation</strong> (e.g., hotel reservations). If you are not staying in a hotel, the official recommendations I could find are slightly vague. If your academic host provides you with other form of accommodation (e.g., the University owns flats dedicated to host visitors and staffs), I think the host should mention it on the invitation letter and maybe provide you with a filled <a href="https://bio.visaforchina.cn/MAC3_EN/qianzhengyewu/jichuzhishi/changjianwenti/230221174293008384.html">invitation form</a>. If you stay at a relative or friend’s place, ask them to fill an <a href="https://bio.visaforchina.cn/MAC3_EN/qianzhengyewu/jichuzhishi/changjianwenti/230221174293008384.html">invitation form</a> which contains various information including dates of stay, address, and Chinese ID number. Beware that if you are not staying in a hotel, you will have to register at the police station within 24 hours; more is said about this in section <a href="https://bvieuble.me/blog/2025/chinavisit3/#hotel">Hotel</a>.</li> </ul> <p>It is strongly recommended that you have everything printed and ready to be presented at the border. Note that you may not be asked to show all these documents; this is up to the judgment of the border agent. If you wish, you can also complete this list with other documents that might serve as proof that you have an on-going working contract as an academic or a researcher outside of China, that you are covered by a travel insurance, that you have enough money to sustain yourself, etc. You will most likely not be asked to provide one of these, yet, if this is not too inconvenient to obtain, it certainly won’t hurt.</p> <blockquote class="block-warning"> <h5 id="️-the-phd-student-case">⚠️ The PhD student case</h5> <p>Beware that a visa exemption does not cover entrance to mainland China for the purpose of work, journalism, and <strong>STUDY</strong>. In particular, in China, a PhD student is fully considered a “student”. Hence, if you are a PhD student, it should be clarified with your host institution or organism in China if your visit falls within the “study” or “exchange” classification. With the first, you are provided with an admission notice or letter that you should use to apply for a study visa. With the second, you should be provided with an invitation letter and, depending on your nationality, can be exempt from holding a visa.</p> </blockquote> <h3 id="if-you-need-a-visa">If you need a visa</h3> <p>There are different kinds of visas you can apply for to enter mainland China, and all have different requirements. The type of visa you need depends on the purpose and length of your visit. If you are coming to China for a short academic trip (e.g., invited to give a talk at a seminar, visiting a scholar for collaboration, attending conferences or workshops, etc.), you likely need an F visa. You can find more detailed information about F visa on <a href="https://www.travelchinaguide.com/embassy/visa/f-visa.htm">Travel China Guide</a> for instance. In addition, a step-by-step visa application guide can be found on <a href="https://travelchina.guide/visa/application">Travel China</a>.</p> <p>In short, you should be asked to provide the following documents to apply for an F visa:</p> <ul> <li><strong>Passport</strong> with two blank visa pages, plus a photocopy of the passport’s bio page.</li> <li>A <strong>Visa Application Form</strong> which has to be filled out online on the <a href="https://bio.visaforchina.cn/">Chinese visa Application Center</a> website and which should be printed and signed. Note that you must pick the country/city where you wish to apply for the visa at this step.</li> <li>Passport-sized <strong>photo</strong> in color and with a white background.</li> <li>An <strong>official invitation letter</strong> from your host. A scanned and printed version of the letter is generally acceptable. Sometimes, the invitation mentions the city where you must apply for the visa. For this reason, let your host know early in which city you would like to submit your application.</li> <li>A proof of legal residence if you are applying in a country other than your home country (e.g., a visa or residence permit).</li> </ul> <p>Once you have filled and validated the application on the <a href="https://bio.visaforchina.cn/">Chinese visa Application Center</a> website, you must bring all the required documents to the visa application center of the city of your choice. From my understanding, appointments are no longer required in many visa centers, and you can visit the center during working hours to submit the application at the time of your convenience. You will also have to pay the visa fee at the center while applying.</p> <p>Again, this is a very important business and you don’t want to mess it up, so don’t take my words for granted and check carefully the requirements that apply to you on the <a href="https://bio.visaforchina.cn/">Chinese visa Application Center</a> website. After you have entered your country and city of application on the aforementioned website, you can go to the <em>Visa Category</em> link to learn more about the requirements and documents you need to prepare.</p> <blockquote class="block-warning"> <h5 id="️-using-a-visa-agency">⚠️ Using a visa agency</h5> <p>If you live far away from your nearest visa center, you might be tempted to use a third-party visa agency. With their services, you can apply for visas from the comfort of your home without having to travel to the visa centers or embassies yourself. HOWEVER, in the case of Chinese visa application, beware that you may or may not be required to come to the visa center in person to have your fingerprints taken! You should consider contacting the visa agency before booking their services to verify if you can avoid the trip to the center.</p> </blockquote> <p>To cross the border you imperatively need to hold a valid visa for the period of your academic visit. Pay attention to the number of entries you need while applying for the visa and the number of entries that have been granted once the visa is issued. In particular, any trip to Hong Kong, Macau, or Taiwan is an exit from mainland China. Hence, if you take a day break in Hong Kong while in Shenzhen for a conference, you won’t be able to go back under a single-entry visa!</p> <p>Note also that in addition of your passport and visa, while at the immigration desk, you may be asked to provide the documents listed in <a href="#visa-exemption">Visa exemption</a>.</p> <h2 id="list-of-useful-material">List of useful material</h2> <ul> <li>Visa exemption: <a href="https://travelchina.guide/visa/free">Travel China</a>, <a href="https://www.mfa.gov.cn/wjbzwfwpt/kzx/tzgg/202411/t20241130_11535783.html">Chinese government</a></li> <li>Invitation form: <a href="https://bio.visaforchina.cn/MAC3_EN/qianzhengyewu/jichuzhishi/changjianwenti/230221174293008384.html">Visa for China</a></li> <li>F visa application: <a href="https://www.travelchinaguide.com/embassy/visa/f-visa.htm">Travel China Guide</a></li> <li>Tuto for visa application: <a href="https://travelchina.guide/visa/application">Travel China</a></li> <li>Applying for a visa online: <a href="https://bio.visaforchina.cn">Chinese Visa Application Center</a></li> </ul> <h2 id="continue-the-guide">Continue the Guide</h2> <ul> <li>Continue to Part 2 (internet, payments, and other essentials): <a href="https://bvieuble.me/blog/2025/chinavisit2">Academic visit in China (2/3)</a></li> <li>Continue to Part 3 (once arrived): <a href="https://bvieuble.me/blog/2025/chinavisit3">Academic visit in China (3/3)</a></li> <li>Print your TODO list: <a href="https://bvieuble.me/blog/2025/chinavisit4">Academic visit in China (TODO list)</a></li> </ul>]]></content><author><name></name></author><category term="chinalife"/><category term="china"/><category term="travel"/><summary type="html"><![CDATA[Everything you need to know about preparing your short academic visit in China. Part 1/3 - Introduction and visa.]]></summary></entry><entry><title type="html">Academic visit in China (2/3)</title><link href="https://bvieuble.me/blog/2025/chinavisit2/" rel="alternate" type="text/html" title="Academic visit in China (2/3)"/><published>2025-02-10T00:01:00+00:00</published><updated>2025-02-10T00:01:00+00:00</updated><id>https://bvieuble.me/blog/2025/chinavisit2</id><content type="html" xml:base="https://bvieuble.me/blog/2025/chinavisit2/"><![CDATA[<style>body{text-align:justify}</style> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blog/payment-480.webp 480w,/assets/img/blog/payment-800.webp 800w,/assets/img/blog/payment-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/blog/payment.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h2 id="on-the-importance-of-being-prepared-before-the-trip">On the importance of being prepared before the trip</h2> <p>Apart from cultural and language differences, mainland Chinese society uses and relies on tools that are critically different from what you may be used to. From paying to ordering at the restaurant, including taking public transport and browsing the internet, you are here for quite an adventure. Being aware and prepared for these differences is all the more important because you are coming for work. Hence, I imagine you’d prefer being efficient on day one rather than troubleshooting your internet access for hours and hours to come.</p> <p>Fortunately, after reading part two of the <em>“Academic visit in China”</em> guide, you’ll be fully ready and equipped to carry out your work in this new environment and navigate Chinese cities (almost) as a Chinese. If you are already a veteran of the Chinese life-style and can blend like a chameleon into Chinese cities, you can go check out the other parts of the guide listed in <a href="#continue-the-guide">Continue the Guide</a> and print your <a href="https://bvieuble.me/blog/2025/chinavisit4">TODO list</a>.</p> <h2 id="internet-in-china">Internet in China</h2> <p>You might or might not know that <strong>many overseas services and websites are banned</strong> and blocked on mainland China. This includes many tools that may be critical for your research workflow or daily life:</p> <ul> <li>Messaging apps like WhatsApp, Messenger, Telegram, or Signal.</li> <li>Every Google service, notably Gmail, Google Scholar, Google Play Store, YouTube, or Google Maps.</li> <li>Cloud services like Dropbox, Google Drive, PCloud, or Proton Drive.</li> <li>Social media like Facebook, Instagram, X, LinkedIn, or Mastodon.</li> <li>Other honorable mentions include Discord, Wikipedia, most Western news journals (e.g., BBC, The Guardian, etc.), and ChatGPT.</li> </ul> <p>This blocking system is called the <em>Great Firewall of China</em>. It is the best system of its kind and can detect and block even encrypted and obfuscated internet traffic. Most common and widely-used VPN protocols and services cannot escape the blocking. This includes the most well-known VPN commercial services: ExpressVPN, NordVPN, Surfshark, CyberGhost, etc. I emphasize that all the aforementioned services do not work reliably in China, regardless of deceptive advertisements you can read online.</p> <p>Unfortunately, it is also to be noted that while most international scientific journal websites can be accessed in China, I often experienced the ones I read being sluggish and inconvenient to use. The same can be said for Github, StackOverflow, and Zoom meetings, for which access is unreliable.</p> <p>Of course, if you stay in China long-term, limiting your dependence on some of these tools would facilitate your work and life. Specifically, for most of these banned services, you can find a Chinese equivalent that works well and, in the case of Cloud storage for instance, can be far cheaper. It is, however, <strong>inconceivable to drastically change your whole workflow just for the sake of a few days short visit</strong>.</p> <blockquote class="block-tip"> <h5 id="-apple-products-a-safe-haven">✅ Apple products: a safe haven</h5> <p>Note that the ban on Google services will disrupt the proper functioning of Google-based Android phones. On the other hand, most Apple services and products are allowed in mainland China and offer a smoother transition.</p> </blockquote> <p>The good news is there are solutions! Some of them are in a gray area regarding the local laws, such as VPNs or Proxies. Some others are fully legal! It is critical to <strong>anticipate this problem before your departure!</strong> Your range of solutions will be more limited once you are in mainland China.</p> <h5 style="text-align: center;"> <em> Let's now develop on a few of these solutions! </em> </h5> <p>An option you might consider is to subscribe to an <strong>international data plan</strong> with your current mobile phone operator if they offer such a service. Carefully check if mainland China is included in the coverage, and don’t hesitate to contact your operator for more details. In particular, confirm with them that you will be able to access the Western internet. You can then use your phone (or any other device carrying the SIM) as a hotspot.</p> <p>If your phone is eSIM compatible, you can also buy data plans covering mainland China from various <strong>eSIM service providers</strong>. You can consider buying from <a href="https://www.airalo.com/">Airalo</a> or <a href="https://www.getnomad.app/">Nomad</a> which, at the time of writing this post, are reported to work well in China to access Western services. You have plenty of other options outside of the two services mentioned. Beware that these plans are generally data-only and do not provide a local number.</p> <p>In my opinion, international data plans and eSIM are the most reliable solutions for an academic visitor, but they provide you with a limited amount of data. For a short stay, you’ll be fine with light internet usage (i.e., emails, internet browsing, checking Google Scholar and GMail, watching videos, etc.). However, if your work absolutely requires more usage-heavy access to blocked Western services (e.g., download and sync big files on Dropbox), <strong>reach out for advice</strong> from the scholars working in mainland China who invited you. They are likely to provide you with better advices and solutions than what you can find online.</p> <blockquote class="block-warning"> <h5 id="️-resilience-is-key">⚠️ Resilience is key!</h5> <p>Internet access to Western services is evolving quickly and unpredictably. What works today might not work tomorrow. What works in one Chinese region might not work in another. Hence, it is important to prepare yourself for the eventuality that the services you are using will be disrupted. Inform your family and colleagues beforehand that you might not be easily reachable, don’t schedule important Zoom meetings during the time of your visit, etc.</p> </blockquote> <h2 id="prepare-your-apps">Prepare your apps!</h2> <p>In mainland China, many daily life services are only accessible or substantially facilitated through mobile apps. As a short-term visitor, your primarily needs in that regard will be to:</p> <ul> <li>Pay for things</li> <li>Chat with your local Chinese colleagues.</li> <li>Use public transportation.</li> <li>Hail for a taxi.</li> <li>Order at the restaurant.</li> <li>Know where you are on a map.</li> <li>And translate things.</li> </ul> <p>I might have missed some, but it is definitely a good start. The good thing is you can achieve all of this by installing only three phone apps: <strong>Alipay</strong>, <strong>WeChat</strong>, and <strong>Amap</strong>. Ultimately, you can complete this list with any app you may feel the need to use.</p> <p>I strongly recommend <strong>installing and setting up every phone app you need BEFORE your departure</strong>. Many problems that are hard to anticipate can occur due to the blocking of many of your favorite internet services and other various reasons when you are in China. Moreover, if you find yourself having an issue installing an app, you might not be able to rely on Google, YouTube, Reddit, etc., to troubleshoot and find a solution.</p> <blockquote class="block-tip"> <h5 id="-dont-worry-too-much-you-can-survive-without-the-apps">✅ Don’t worry too much: you can survive without the apps</h5> <p>Setting up WeChat, Alipay, and Amap can greatly facilitate your stay, but you will be just fine without them. So, if you forgot to install them or did not manage to set them up before your departure, don’t worry too much. I am sure your trip will be pleasant.</p> </blockquote> <h3 id="alipay">Alipay</h3> <p>During your stay, you’ll likely need to pay for goods and services on mainland China. It is important to know that the Chinese do not use a bank card as a general means of payment; many shops do not accept it. Cash payment in RMB currency can be used and is reliable, but it is not practical and can sometimes be a bit restrictive. For instance, taxi drivers, small restaurants, or small businesses can accept cash but might not be able to give you the change. Instead, the Chinese use digital payment methods through phone apps like Alipay.</p> <h5 style="text-align: center;"> <em> When in Rome, pay as the Romans pay! </em> </h5> <p>Setting up Alipay with one of your bank cards will substantially improve your payment experience in China. However, as evoked previously, this matter should require your attention early because the app will proceed to an identity check. This process simply consists of filling in some basic information and sending a photo of your passport. Upon sending the required information, it may take up to a few hours or days to receive the clearance and finally be able to pay with the app. Alipay may also need phone verifications to register and link a bank card. Hence, if you are uncertain whether you can receive SMS in China, it is important to have your bank card linked before your trip.</p> <blockquote class="block-tip"> <h5 id="-talk-to-your-bank">✅ Talk to your bank</h5> <p>Your bank card will be used through Alipay, or you might use it to withdraw more cash at a Chinese ATM. Contact your bank and ensure that you can use your credit card in China. Even if you are confident your card can be used, it is generally a good practice to let your bank know that transactions will be made in China. Otherwise, they may block your card thinking the transaction is fraudulent.</p> </blockquote> <p>Recent efforts to improve tourist experiences in mainland China have transformed Alipay into an incredible Swiss Army Knife for the ease of your travel. In addition to payment, it offers a convenient way to take the subway and buses, hail a taxi, order at the restaurant, book trains, planes, and hotels, or translate. Alipay can be set in English for your convenience and features besides that various guides and tutorials. A must-have in my opinion.</p> <p>To set up Alipay with one of your bank cards, I recommend following the helpful video: <a href="https://www.youtube.com/watch?v=3xEM6Hkn_EY">Setup Alipay</a>. In addition, I encourage you to watch the following tutorials to see how to use the app in real-life situations: <a href="https://www.youtube.com/watch?v=tuS7JL35PwQ">Payment and Menu</a>, <a href="https://www.youtube.com/watch?v=0NP_FtyaC9Y">Translate</a>, <a href="https://www.youtube.com/watch?v=-fgwiKLswUY">Public transport, bikes, and taxi</a>, and <a href="https://www.youtube.com/watch?v=BHz5M9Cuyfg">Plane, train, and hotel</a>.</p> <blockquote class="block-warning"> <h5 id="️-payment-with-alipay-needs-internet">⚠️ Payment with Alipay needs internet!</h5> <p>Mobile payments require an internet connection, so make sure you have data or access to Wi-Fi.</p> </blockquote> <p>Usually, as long as your card is a Visa or a MasterCard, you should be able to link it to Alipay. However, in practice, depending on your bank and options, you may face bad surprises. Try to link your card beforehand and give yourself a comfortable amount of time to troubleshoot problems, if any.</p> <p>The multi-currency card of <a href="https://wise.com/ca/card/">Wise</a> has been reported to work well with Alipay and offers good conversion rates. Setting up a Wise account and getting a Wise card is easy and accessible to many. In particular, if you don’t like the idea of putting your credit card credentials into Alipay, Wise offers the possibility of generating digital cards that you can link and use instead. You can delete the digital card right after your trip. <a href="https://www.revolut.com/en-US/cards/">Revolut</a> also offers the same digital card system and is reported to work with Alipay. I emphasize that Alipay is a behemoth in China, and you can be reassured that you are not giving your card credentials to some unknown shady company; hundreds of millions have done it before you.</p> <h3 id="wechat">WeChat</h3> <p>Alipay embeds almost every essential you need for your travel. There is, however, one exception: you cannot call and chat with your peers in China. This is what WeChat is used for. Basically, it is a sort of WhatsApp on steroids where, in addition to chatting with your friends, you can do almost everything Alipay does and more. However, unless you feel strongly about using WeChat, Alipay has a friendlier interface for foreigners for the same functionalities.</p> <p>In my opinion, installing WeChat is optional, and whether you should install it or not depends on the nature of your visit. An example of a use case is if you need to send messages or call your academic hosts or other peers you might meet during your visit. If you choose not to get a <a href="https://bvieuble.me/blog/2025/chinavisit3/#chinese-sim">Chinese SIM</a> card, you may not be able to call them and send them SMS. Hence, in this case, you should have WeChat installed and set up. On the other hand, if communicating by email is enough, you might as well not clutter up your phone with another app. The best thing to do is to ask your hosts in China if they think you should have it installed.</p> <p>Because WeChat requires phone number verification, it is better to have it set up and running before your departure if you do not plan to get a Chinese phone number. To set up WeChat, I recommend following the video tutorial <a href="https://www.youtube.com/watch?v=UTors6B0bSQ">Setup WeChat</a>. In addition, I encourage you to watch the following tutorial to see how to use the basic chat functionalities of WeChat: <a href="https://www.youtube.com/watch?v=7qRucDPdDaE">Add friend, chat, and translate</a>.</p> <blockquote class="block-warning"> <h5 id="️-wechat-can-be-a-pain-to-set-up">⚠️ WeChat can be a pain to set up…</h5> <p>Contrary to Alipay, you can encounter various difficulties in setting up WeChat. A common problem, explained in the <a href="(https://www.youtube.com/watch?v=UTors6B0bSQ)">Youtube video</a> linked above, is the security check requiring an existing WeChat user to verify you by scanning a QR code. If it pops up, simply ask your hosts in China to scan the code to unblock your account. Note that there might be a time limit for the validity of the QR code after which you will need to regenerate the code.</p> </blockquote> <h3 id="amap">Amap</h3> <p>Your last fundamental for traveling in China is a good map app. Of course, Google Maps, as a Google product, is blocked. You may still use it if you can access the unblocked Western internet on your phone; see <a href="#internet-in-china">Internet in China</a>. However, even in this case, Google Maps won’t provide you with updated information and routes. If you have an iPhone, the built-in iOS map app offers a decent service but does not provide the same level of detail as Chinese map apps.</p> <p>Until very recently, it was actually tricky to have a map app that is both in English and works well in China. Chinese map apps are feature-rich and efficient, but they were ultimately in Chinese… Thankfully, recent efforts to boost tourism have led to an English version of one of the leading map apps in China: Amap. I strongly recommend installing it. The app should be available on both the Google Play store and the iOS appstore.</p> <blockquote class="block-tip"> <h5 id="-my-amap-is-in-chinese-scream">✅ My Amap is in Chinese :scream:</h5> <p>After the installation, if your Amap is in Chinese, don’t panic. You can change the language. Click on “我的” in the bottom right corner, click on the parameter icon in the top right corner, click on “通用”, scroll down, and click on “语言设置”. Select “English”, close the app, and relaunch it.</p> </blockquote> <h2 id="health-insurance">Health insurance</h2> <p>It is always good to remember that, even though academic research exchanges rarely put yourself at physical risk, you are never 100% safe from an accident requiring urgent and local medical attention. As for any trip to a foreign country, it is highly recommended (and sometimes mandatory) to be covered by a travel medical insurance.</p> <p>If you are traveling in the most developed cities in China, you can rest assured that you will receive urgent care from competent staff, if necessary, at a reasonable price. You are not going to empty your bank account over a broken arm :wink:</p> <p>I would also strongly recommend talking to your general practitioner about potential vaccines you must get before your travel. If you are not travelling in remote poorer rural areas, you might not be advised to get anything other than what is already recommended in your own country.</p> <h2 id="list-of-useful-material">List of useful material</h2> <ul> <li>App direct download: <ul> <li><a href="https://render.alipay.com/p/s/download?form=chinese">Alipay</a></li> <li><a href="https://www.wechat.com/">WeChat</a></li> <li><a href="https://www.amap.com/download">Amap</a></li> </ul> </li> <li>Commercial services (I am not sponsored btw :stuck_out_tongue:): <ul> <li>eSIM: <a href="https://www.airalo.com/">Airalo</a>, <a href="https://www.getnomad.app/">Nomad</a></li> <li>Multi-currency account and card: <a href="https://wise.com/">Wise</a>, <a href="https://www.revolut.com/">Revolut</a></li> </ul> </li> <li>Tutorials: <ul> <li><a href="https://www.youtube.com/watch?v=3xEM6Hkn_EY">Alipay For Foreigners WITHOUT China Bank Cards</a></li> <li><a href="https://www.youtube.com/watch?v=UTors6B0bSQ">How to Sign Up WeChat Account - WeChat Registration STEP BY STEP</a></li> <li><a href="https://www.youtube.com/watch?v=tuS7JL35PwQ">Travel Like a Local in China: A Step-by-step Guide on How to Use Alipay</a></li> <li><a href="https://www.youtube.com/watch?v=0NP_FtyaC9Y">Travel Smart in China with Alipay: Translation &amp; Payment Function Explained</a></li> <li><a href="https://www.youtube.com/watch?v=-fgwiKLswUY">Travel Smart in China with Alipay: How to Ride Subway, Bus &amp; Shared Bikes and Hail Cars</a></li> <li><a href="https://www.youtube.com/watch?v=BHz5M9Cuyfg">Travel Smart in China with Alipay: How to Buy Plane &amp; Train Tickets, Tourist Passes, and Book Hotels</a></li> <li><a href="https://www.youtube.com/watch?v=7qRucDPdDaE">WeChat guide for beginners - How to use WeChat - WeChat tutorial</a></li> </ul> </li> </ul> <h2 id="continue-the-guide">Continue the Guide</h2> <ul> <li>Go back to Part 1 (introdution and visa): <a href="https://bvieuble.me/blog/2025/chinavisit1">Academic visit in China (1/3)</a></li> <li>Continue to Part 3 (once arrived): <a href="https://bvieuble.me/blog/2025/chinavisit3">Academic visit in China (3/3)</a></li> <li>Print your TODO list: <a href="https://bvieuble.me/blog/2025/chinavisit4">Academic visit in China (TODO list)</a></li> </ul>]]></content><author><name></name></author><category term="chinalife"/><category term="china"/><category term="travel"/><summary type="html"><![CDATA[Everything you need to know about preparing your short academic visit in China. Part 2/3 - Internet, payments, and other essentials.]]></summary></entry><entry><title type="html">Academic visit in China (3/3)</title><link href="https://bvieuble.me/blog/2025/chinavisit3/" rel="alternate" type="text/html" title="Academic visit in China (3/3)"/><published>2025-02-10T00:01:00+00:00</published><updated>2025-02-10T00:01:00+00:00</updated><id>https://bvieuble.me/blog/2025/chinavisit3</id><content type="html" xml:base="https://bvieuble.me/blog/2025/chinavisit3/"><![CDATA[<style>body{text-align:justify}</style> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blog/airport-480.webp 480w,/assets/img/blog/airport-800.webp 800w,/assets/img/blog/airport-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/blog/airport.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <h2 id="you-are-almost-ready">You are almost ready…</h2> <p>The day has finally come, and after a long trip and maybe some sleep deficit, you’re disembarking to head to the border and proceed to immigration. Now, only a stamp on your passport separates you from entering China and, soon enough, you will need to navigate your way in the city to start your academic activities. You wonder with apprehension and excitement what is to come, but fear not! I have yet to share a few last pieces of advice that may help you.</p> <p>In part three of the “Academic visit in China” guide, we will review the process at border control and the few basics to start your trip serenely once arrived. For simplicity of exposition, I assume that you are entering China through one of the country’s major international airports. I imagine the process to be relatively similar when crossing the border by boat, train, or car. If you missed or forgot about the first two parts of the guide, you can check them out in <a href="#continue-the-guide">Continue the Guide</a>. You can also print and review your <a href="https://bvieuble.me/blog/2025/chinavisit4">TODO list</a> to guarantee you missed nothing.</p> <h2 id="arrival-and-immigration">Arrival and immigration</h2> <p>If this is your first time in China, you’ll need to get your <strong>fingerprints</strong> done at one of the counters in the airport on arrival. You cannot miss it, it is generally located just before immigration. If you don’t see any and are not invited by the staff to go to such counters, your fingerprints may be taken when you will face the border agent.</p> <blockquote class="block-danger"> <h5 id="-dont-do-drugs">🚫 Don’t do drugs!</h5> <p>As for many Asian countries, carrying drugs or even just testing positive for drug consumption can get you in extremely severe trouble. It includes marijuana. So, if marijuana is legal back in your home country and you are consuming it frequently, you should make sure to have no residuals on your clothes and luggage. You should also stop your consumption early before your trip to have no residual in your blood.</p> </blockquote> <p>Importantly, you will need to fill an <strong>arrival card</strong> before entering China, which you will hand to the border agent. The card is generally yellow or blue and distributed on the plane or, if not, also available at the airport on arrival. The card asks for basic information such as name, passport number, visa number, flight number, expected date of departure, etc. Some of the demanded information is worse preparing in advance:</p> <ul> <li>You will have to tick the <strong>reason of stay</strong> amongst various choices. Those include “Visiting/Business”, “Tourism”, “Transit”, “Visiting Relatives”, “Employment”, or “Study”. It may not appear with the exact same formulations when you fill out the card yourself. Tick what is the most relevant to your situation. If, for instance, you are coming for an academic workshop or conference, I would tick “Visiting/Business”. If none of the choices in the list seem adequate, you might tick “Others” if proposed. If you are coming with an F visa or under a visa exemption, it is a terrible idea to tick “Study” or “Employment”! You should hold a study or working visa to be authorized to do these activities in China.</li> <li>You will need to provide your <strong>address of stay</strong>. If you intend to not stay at the same place, you may only write the address of the first hotel. Beware that it is generally a good idea to have this information prepared in advance and accessible offline. Specifically, you might not be able to easily check your hotel’s address online when it will be time to fill the card; see <a href="https://bvieuble.me/blog/2025/chinavisit2/#internet-in-china">Internet in China</a>.</li> <li>You may be asked to provide the <strong>reception unit or contacts in China</strong>, if any. In the case of an academic exchange, it refers to the entity or person who gave you the invitation letter. Write the name of the institute, university, company, or person who invited you and their address. As for the previous bullet point, ensure that you have this information accessible offline.</li> </ul> <p>The border agent might ask you for further documents to validate the information declared on the arrival card. It includes the documents listed in <a href="https://bvieuble.me/blog/2025/chinavisit1/#visa-exemption">Visa exemption</a>. For this reason, have them printed and keep them easily reachable in your bag or carry-on luggage.</p> <blockquote class="block-tip"> <h5 id="-have-a-pen-in-your-carry-on-luggage">✅ Have a pen in your carry-on luggage</h5> <p>There aren’t many pens available at the airport to complete the arrival card. If you don’t want to wait and reach the queue as quickly as possible, bring a pen in your carry-on and fill out the card in advance while on the plane.</p> </blockquote> <p>Next, you will need to go through customs. As an academic visitor, unless you bring chemicals, metals, or advanced hardware, you are unlikely to carry goods requiring a declaration. Just get informed about food product bans that can occur due to animal disease outbreaks before departure, and apply common sense to the rest. You can check out the official <a href="http://english.customs.gov.cn/Statics/88707c1e-aa4e-40ca-a968-bdbdbb565e4f.html">Customs Clearance Guidelines</a> if you look for more information.</p> <p>You can find a nice guide about the arrival at the airport on the <a href="https://ruqintravel.com/survival-guide/beijing-airport/">Ruqin China Travel</a> webpage.</p> <h2 id="i-passed-the-border-and-now-what">I passed the border, and now what?</h2> <p>First things first, congratulations! After all the paperwork, the long travel, and the queuing at the border, you’re finally in China and the most tedious part is behind you. What is left is to enjoy the trip!</p> <p>However, before rushing to your peers and starting the research work, there might be a little few things you might want to consider…</p> <h3 id="chinese-sim">Chinese SIM</h3> <p>If you need a Chinese phone number and internet data, the easiest way is certainly to sort yourself at one of the Chinese SIM stores in the airport on arrival. Beware that standard data plans from Chinese SIM you can buy at the airport come with the limitations of the Chinese internet on Western services. Hence, before choosing this option, I highly recommend you to read my section <a href="ttps://bvieuble.me/blog/2025/chinavisit2/#internet-in-china">Internet in China</a>.</p> <p>A Chinese phone number is essential for someone staying long-term in China. You need one to open a bank account, rent, or enjoy certain services and mobile apps. It is, in my opinion, far less critical for someone coming for a short-term visit. If you already have a data plan through one of the solutions developed in <a href="https://bvieuble.me/blog/2025/chinavisit2/#internet-in-china">Internet in China</a>, the main need for getting a phone number would be to call and send SMS to your colleagues in China. However, if you have WeChat set up and running, you can already do these things; we review how to <a href="https://bvieuble.me/blog/2025/chinavisit2/#wechat">Set up WeChat</a> in part 2 of this guide. Don’t hesitate to ask the people who invited you for advice. They might actually need you to have a local phone number for specific tasks or activities requiring it.</p> <h5 style="text-align: center;"> <em> If you are in China for a short trip, you likely don't need a Chinese phone number. Be sure however to have plenty of data. </em> </h5> <p>If you need a Chinese SIM and there are no SIM card stores at the airport, or you are arriving late (or early) and the stores are not open, you can still visit one of the leading Chinese mobile phone operators in town; for instance, China Mobile, China Unicom, or China Telecom.</p> <h3 id="get-some-cash">Get some cash</h3> <p>As explained in <a href="http://bvieuble.me/blog/2025/chinavisit2/#alipay">Alipay</a>, most payments are now digital, but the vast majority of businesses still accept cash. For your convenience, you definitely want to use one of these phone-app-based payment methods. I recommended using <a href="http://bvieuble.me/blog/2025/chinavisit2/#alipay">Alipay</a> which offers the most foreigner-friendly interface. Yet, I would also strongly encourage keeping some cash on you just in case, as a fallback. For instance, there might be instances where your Alipay payment will fail, and you will be glad to carry some cash to avoid an uncomfortable situation.</p> <p>You can easily get some Chinese currency at the airports, either before taking off or after landing. The fees and exchange rates might not be good, but if you already set up <a href="http://bvieuble.me/blog/2025/chinavisit2/#alipay">Alipay</a> and linked a bank card to it, you only need a small amount of cash. If you are traveling solo, I recommend constantly keeping 400RMB, which should easily cover most taxi/restaurant/attraction ticket bills for which you unexpectedly cannot use the app.</p> <blockquote class="block-tip"> <h5 id="-withdraw-cash-from-atm-in-town">✅ Withdraw cash from ATM in town</h5> <p>You can withdraw cash from most ATMs with your foreign bank card while in town. Note that some Chinese banks might apply a small fee. Generally, the display language on the ATM can be turned to English. If you fail to withdraw, retry using an ATM from another bank. If it fails again, contact your bank, your card might have been blocked or is unauthorized to do international transactions.</p> </blockquote> <h3 id="transportation">Transportation</h3> <p>If you must go from the airport to your hotel by yourself, you should not worry, it is generally very easy. In most major cities in mainland China (Beijing, Shanghai, Shenzhen, etc.), you will have two main advantageous and affordable choices: subway or cab. Of course, if you go to a smaller city, you might not have the subway option.</p> <blockquote class="block-warning"> <h5 id="️-have-a-working-map-app-prepared">⚠️ Have a working map app prepared</h5> <p>We explained in <a href="https://bvieuble.me/blog/2025/chinavisit2/#internet-in-china">Internet in China</a> that Google Maps is blocked. For this reason, I strongly recommend having  <a href="http://bvieuble.me/blog/2025/chinavisit2/#amap">Amap</a> installed and set in English to check the possible routes to your hotel. Of course, as long as you have the address of your accommodation, you can still ask the airport or subway staffs for help.</p> </blockquote> <h4 id="taxi">Taxi</h4> <p>To take a taxi, you should go to the airport’s official taxi line. It is often well-indicated and easy to find. It is where the official and licensed taxi drivers are. Once you have spotted the taxi pick up line, just queue in the line with the other travelers and, at your turn, you’ll be affected to a driver. Every major Chinese airport has a taxi line, so don’t follow anyone proposing their service at the arrival hall; it might be a scam. Maybe, by precaution, make sure that the taxi driver uses the meter; any excuse not to use it should be a red flag.</p> <p>Beware that you cannot pay the taxi driver with a credit card. The best is to use <a href="http://bvieuble.me/blog/2025/chinavisit2/#alipay">Alipay</a>. The process is simple. After the ride, when it is time to pay, the taxi driver will show you a QR code. Scan it with Alipay, enter the amount, and validate the transaction with your secret code. You can watch the video tutorial <a href="https://www.youtube.com/watch?v=tuS7JL35PwQ">Payment and Menu</a> to learn how to pay with Alipay. As a fallback, always have cash if the Alipay transaction fails for some reason. It is better to have at least a few smaller bills if possible since, with the emergence of numerical payment, the driver might not have what it needs to give you the change.</p> <p>Suppose the airport doesn’t have an official taxi line. In that case, your best option is to use a Chinese taxi-hailing app such as Didi, which is conveniently integrated as a mini-app inside Alipay. So, if you completed the <a href="https://bvieuble.me/blog/2025/chinavisit2/#alipay">Alipay set up</a> described in part two of this guide, you should already have it. It works mostly like Uber and has the advantage of providing you with an estimate of the fare. You can learn how to use Alipay to hail a taxi in the video tutorial <a href="https://www.youtube.com/watch?v=-fgwiKLswUY">Public transport, bikes, and taxis</a>.</p> <p>You can also find further guidance about taxis in China on the <a href="https://ruqintravel.com/china-destination-guides/beijing-taxi-guide/">Ruqin China Travel</a> website.</p> <blockquote class="block-warning"> <h5 id="️-when-in-doubt-use-a-taxi-hailing-app">⚠️ When in doubt, use a taxi-hailing app</h5> <p>Outside of airports and train stations, your chance of successfully hailing a taxi directly while walking the pavement is reduced. Instead, everybody uses taxi-hailing apps such as Didi (integrated into Alipay), which provides you with a safe and efficient service. In case you cannot use the app, I would strongly advise against accepting the service of anybody outside official taxi lines, particularly nearby main tourist areas or smaller train stations. The service offered are often scammy…</p> </blockquote> <h4 id="subway">Subway</h4> <p>Most major Chinese airports are conveniently connected to the city’s subway network. Finding the station at the airport is easy. For a solo traveler, the subway is usually cheaper than the taxi. To be noted that the taxi itself is very affordable compared with Europe or North America. When traveling in small groups (i.e., three to four persons), the taxi may come out cheaper per head. To pay for the subway service, you mostly have three options:</p> <ul> <li>You can use the <strong>Alipay app</strong> (personal favorite). It is very convenient if you already have <a href="http://bvieuble.me/blog/2025/chinavisit2/#alipay">Alipay set up</a> for payment by following part two of this guide. In addition, it has the advantage of working with buses and is widely implemented and useable in all major Chinese cities. You can find a good tutorial to set up your Alipay for taking public transport on <a href="https://www.thebeijinger.com/blog/2024/08/02/welcome-beijing-how-ride-subway">The Beijinger</a> website and you can learn more about how to use Alipay with public transports by watching the video tutorial <a href="https://www.youtube.com/watch?v=-fgwiKLswUY">Public transport, bikes, and taxi</a>.</li> <li><strong>Contactless card payment</strong>. In some cities, it is now possible to swipe your credit card at the barriers to enter the subway. Swipe again when you exit the subway. The method is relatively new, and is not implemented everywhere.</li> <li><strong>Buy a ticket at the counter</strong>. You can get a “standard” physical subway ticket by using one of the ticket machines. Unfortunately, I have experienced some of these machines in Beijing to require a Chinese ID and, so, being unusable for foreigners. If this is the case, you can still buy a ticket at a staffed counter. You just need to tell the subway agent your destination station and pay in cash or with a mobile app.</li> </ul> <p>Note that you also have other options: some cities have public transport passes sold at the airport, you could use WeChat (less convenient than Alipay for this purpose in my opinion), or other dedicated subway apps.</p> <p>If you are confused and don’t know how to use the subway, go to the service center of the airport or ask a subway agent at the station; someone can definitely help you out.</p> <blockquote class="block-tip"> <h5 id="-if-you-need-to-claim-expenses-for-metro-travel">✅ If you need to claim expenses for metro travel</h5> <p>Depending on your research institutes, getting the metro travel refunded may be a pain… If you use Alipay, all you have is the history of your transactions in the form of in-app DIGITAL receipts. You could get a Chinese invoice for those expenses in .pdf files, but for some reason the option is not available in the English version of the app. Forget about any receipt if you use contactless payment; all you have is the card payment that should appear on your bank account’s personal space. Your best bet is to buy your ticket at the staffed ticket counter and explicitly ask for a printed receipt.</p> </blockquote> <p>Note that the ticket price varies according to the distance. If you use Alipay or a contactless card payment, it is automatically deducted when you exit the subway or bus. If you buy a ticket at a counter, you must specify your destination carefully and pay the ticket upfront. For instance, you can expect to pay 3-4-5RMB for one travel on the standard lines of the Beijing subway. The airport express lines are more expensive.</p> <blockquote class="block-warning"> <h5 id="️-nothing-sharp-in-the-subway-and-water-bottles">⚠️ Nothing sharp in the subway and water bottles</h5> <p>Your bags and luggage have to go through a detector each time you take the subway. In particular, knives are not allowed in, so forget about traveling with your Swiss Army knife in the luggage! Note also that water bottles are usually tested separately at the entrance of the subway, so they must be taken out of your  bags.</p> </blockquote> <h3 id="hotel">Hotel</h3> <p>Many hotels in major Chinese cities can be booked through Western services such as <a href="https://www.booking.com">Booking.com</a> or <a href="https://www.trip.com/">Trip.com</a>. You can also use <a href="http://bvieuble.me/blog/2025/chinavisit2/#alipay">Alipay</a> to book your hotel; you can check out the video tutorial <a href="https://www.youtube.com/watch?v=BHz5M9Cuyfg">Plane, train, and hotel</a> to learn how to do so. If you use a Chinese service to book your hotel or someone is booking the hotel for you, ensure that the hotel can accept foreigners. Don’t worry. It is not because certain businesses despise foreigners, but rather because they don’t know the procedure to register you.</p> <p>Every hotel must proceed to your registration when you check in, which is basically about declaring to the local police station that you are staying at their place. You have nothing to do in advance; just hand your passport to the hotel agent during the check-in when requested. Once done, the agent will give you back your passport.</p> <blockquote class="block-danger"> <h5 id="-in-case-youre-not-staying-in-a-hotel">🚫 In case you’re not staying in a hotel</h5> <p>If your accommodation is sorted by your host Chinese university or institution, or if you are staying at a relative or friend’s place, you and your host should reach the nearest police station to register within 24 hours of your arrival. Failing to comply with this rule will expose you and your host to trouble… Depending on the city you are staying in, this can  sometimes be done online. Note that hotels proceed to the registration without you having to do anything.</p> </blockquote> <h2 id="acknowledgment">Acknowledgment</h2> <p>Many thanks to <a href="https://eps.leeds.ac.uk/computing/staff/14034/massimiliano-fasi">Max Fasi</a> for fact-checking this guide and providing me with corrections!</p> <h2 id="list-of-useful-material">List of useful material</h2> <ul> <li>Customs declaration: <a href="http://english.customs.gov.cn/Statics/88707c1e-aa4e-40ca-a968-bdbdbb565e4f.html">Customs Clearance Guidelines</a></li> <li>Arriving at the airport: <a href="https://ruqintravel.com/survival-guide/beijing-airport/">Ruqin China Travel - Beijing airport</a></li> <li>Taking the taxi: <a href="https://ruqintravel.com/china-destination-guides/beijing-taxi-guide/">Ruqin China Travel - Taxi</a></li> <li>Ride the subway: <a href="https://www.thebeijinger.com/blog/2024/08/02/welcome-beijing-how-ride-subway">The Beijinger</a></li> <li>Travel agencies: <a href="https://www.booking.com">Booking.com</a>, <a href="https://www.trip.com/">Trip.com</a></li> <li>Tutorials: <ul> <li><a href="https://www.youtube.com/watch?v=tuS7JL35PwQ">Travel Like a Local in China: A Step-by-step Guide on How to Use Alipay</a></li> <li><a href="https://www.youtube.com/watch?v=0NP_FtyaC9Y">Travel Smart in China with Alipay: Translation &amp; Payment Function Explained</a></li> <li><a href="https://www.youtube.com/watch?v=-fgwiKLswUY">Travel Smart in China with Alipay: How to Ride Subway, Bus &amp; Shared Bikes and Hail Cars</a></li> <li><a href="https://www.youtube.com/watch?v=BHz5M9Cuyfg">Travel Smart in China with Alipay: How to Buy Plane &amp; Train Tickets, Tourist Passes, and Book Hotels</a></li> </ul> </li> </ul> <h2 id="continue-the-guide">Continue the Guide</h2> <ul> <li>Go back to Part 1 (introdution and visa): <a href="https://bvieuble.me/blog/2025/chinavisit1">Academic visit in China (1/3)</a></li> <li>Go back to Part 2 (internet, payments, and other essentials): <a href="https://bvieuble.me/blog/2025/chinavisit2">Academic visit in China (2/3)</a></li> <li>Print your TODO list: <a href="https://bvieuble.me/blog/2025/chinavisit4">Academic visit in China (TODO list)</a></li> </ul>]]></content><author><name></name></author><category term="chinalife"/><category term="china"/><category term="travel"/><summary type="html"><![CDATA[Everything you need to know about preparing your short academic visit in China. Part 3/3 - Once arrived.]]></summary></entry><entry><title type="html">Academic visit in China (TODO list)</title><link href="https://bvieuble.me/blog/2025/chinavisit4/" rel="alternate" type="text/html" title="Academic visit in China (TODO list)"/><published>2025-02-10T00:01:00+00:00</published><updated>2025-02-10T00:01:00+00:00</updated><id>https://bvieuble.me/blog/2025/chinavisit4</id><content type="html" xml:base="https://bvieuble.me/blog/2025/chinavisit4/"><![CDATA[]]></content><author><name></name></author><category term="chinalife"/><category term="china"/><category term="travel"/><summary type="html"><![CDATA[Everything you need to know about preparing your short academic visit in China. Summary in a form of a TODO list.]]></summary></entry></feed>